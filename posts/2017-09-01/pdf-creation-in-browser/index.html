<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-39627402-1', {
              page_path: window.location.pathname,
            });
          </script><title>PDF creation in browser</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"/><link rel="canonical" href="https://jokester.github.io/posts/2017-09-01/pdf-creation-in-browser"/><link rel="preload" href="/_next/static/css/cbf8b5770f5f30aa7698.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cbf8b5770f5f30aa7698.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-d42d109db6976c01a5e9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" as="script"/><link rel="preload" href="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" as="script"/></head><body class="overflow-y-scroll"><div id="__next"><div class="bg-black text-yellow-100"><div class="min-h-screen container mx-auto"><div class="px-4 py-1 flex items-center bg-gray-900 space-x-4 text-sm"><a class="sm:hidden text-lg" href="/">挖坑自動機</a><a class="hidden sm:inline-block text-lg" href="/">挖坑自動機 / Digging automaton</a><span>|</span><a class="text-yellow-200" href="/posts/">/posts</a><a class="" href="/works/">/works</a><a class="" href="/about/">/about</a></div><div class="px-4 pt-6"><div class="markdown"><h1></h1><hr/><div class="markdown"><p>When working on a svg-based document viewer in browser, I had a chance to make a pdf-export feature.
This post is a memo about caveats and findings in my quest.</p><ul><li>toc
{:toc}</li></ul><h2>Background</h2><p>A brief <!-- -->&lt;!-- and NDA-compliant--&gt;<!-- --> introduction of the viewer I work on:</p><ul><li>A multipage document viewer running in browser.</li><li>Each page may have a background image in svg format.</li><li>Each page may have multiple vector annotations: text / circle / rect / handdrawn track.</li><li>Annotations can be edited on the fly, and get synchronized between connected clients.</li></ul><h2>How to create pdf in browser</h2><p>We used 2 libraries:</p><ul><li><a href="https://github.com/devongovett/pdfkit">devongovett/pdfkit</a> to create pdf blob</li><li><a href="https://github.com/alafr/SVG-to-PDFKit">alafr/SVG-to-PDFKit</a> to draw svg image to pdf</li></ul><h3>bundle pdfkit for browser use</h3><ul><li>pdfkit has a <a href="https://github.com/devongovett/pdfkit/wiki/How-to-compile-PDFKit-for-use-in-the-browser">How to compile PDFKit for use in the browser</a> guide in <code>github/pdfkit</code> wiki.<ul><li>We did not take this way: use of <code>browserify coffeeify</code> would make our build (currently webpack only) more complicated.</li></ul></li><li>Or, use a webpack-only solution<ul><li>in short: we resolve module dependencies with webpack <code>transform-loader</code></li><li>some dependicies (that exists in node but not browser) are taken from <a href="https://github.com/bpampuch/pdfmake">bpampuch/pdfmake</a></li><li>see my <a href="https://github.com/jokester/random-hack/tree/master/pdfkit-webpack">jokester/random-hack</a> repo for a minimal working example.</li></ul></li></ul><h3>draw svg to pdf</h3><ul><li>We used <a href="https://github.com/alafr/SVG-to-PDFKit">alafr/SVG-to-PDFKit</a><ul><li>internally, this library traversals DOM of svg and draws equivalent vector image with <code>pdfkit</code>.</li><li>If the svg input is a string, a pure js svg parser will be used to build a DOM.<ul><li>This should work in both browser and node</li><li><em>Caveat</em>: this svg parser <em>does not</em> recognize svg strings start with <code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;&gt;</code>. We have to strip this before passing it to <code>SVGtoPDF()</code>.</li><li><em>Note</em>: <code>style</code> attribute in svg string will not be intepreted. If your svg makes use of <code>style=</code>, you have to use <code>SVGElement</code> input and <code>useCSS</code> option. In that case SVG-to-PDFKit uses native <code>getComputedStyle</code> to have browser interprete the style.</li></ul></li><li>The svg input can also be a <code>SVGElement</code> object. Such objects can be obtained from <code>HTMLObjectElement#getSVGDocument()</code> <code>HTMLEmbedElement#getSVGDocument()</code> or <a href="https://stackoverflow.com/a/14070928/327815">XMLHttpRequest</a>.<ul><li>This likely requires a browser to work.</li><li><em>Caveat</em>: chrome may set incorrect prototype for native <code>SVGElement</code>, see <a href="https://github.com/alafr/SVG-to-PDFKit/issues/47">this issue</a> for inspection and a workaround.</li></ul></li></ul></li></ul><h3>remove font data from pdfkit</h3><ul><li>pdfkit and dependencies have more than 1MB (almost not compressable) font data.</li><li>If you do not call <code>pdfDocument.text()</code>, they should be removed from JavaScript bundle.</li></ul><h3>draw not-in-font text to pdf</h3><h3>Browser compatibility</h3><p>pdfkit needs some newer API to deal with binary data. Most browser (effectively everyone except IE) should work fine. The following list shows key features we needed.</p><ul><li><code>IE &gt;= 9</code>:<ul><li>Canvas: for bitmap drawing</li><li>CSS (2d) transform: zoom and scroll DOM element with a transform matrix</li></ul></li><li><code>IE &gt;= 10</code>:<ul><li>Blob / ArrayBuffer / TypedArray: handle binary data in browser</li><li>createObjectURL: can be used to cache arbitrary data (e.g. prefetched svg of all pages)<ul><li>Caveat: blob URLs in IE / Edge look like <code>blob:UUID</code>, and cannot be used as resource of object / embed elements.</li></ul></li><li>FileReader: read string or ArrayBuffer out of a Blob object</li></ul></li></ul><h3>Reduce bundled size of pdfkit</h3>&lt;!-- TODO --&gt;<h2>How to inspect / debug created pdf</h2><h3>By looking at pdf object</h3><p>The Vector images are stored as <em>object</em> in a pdf file.
We can read them after decoding them to textual form.</p><ul><li>see <a href="https://blog.didierstevens.com/2008/05/19/pdf-stream-objects/">PDF Stream Objects</a> for a brief introduction of encoded objects.</li><li>the decode can be done with <code>qpdf</code>: <a href="https://stackoverflow.com/a/29474423/327815">example</a>.</li></ul><p>Reference:</p><ul><li><a href="https://blog.idrsolutions.com/2010/04/understanding-the-pdf-file-format-how-are-images-stored/">Understanding the PDF file format – How Are Images Stored</a></li><li><a href="https://xmlgraphics.apache.org/fop/">apache fop</a> is able to <a href="https://xmlgraphics.apache.org/fop/dev/fo/embedding.fo.pdf">embed svg in its own xml scheme</a>, that can be exported to pdf with fop itself.</li><li><a href="https://github.com/itext/rups/">itext/rups</a> PDF Inspection tool</li></ul><h3>By converting to svg again</h3><p>We can also convert pdf to svg again, to see if that is correct (I found it much easier to inspect text and DOM of svg).</p><ul><li><code>pdfcairo</code> can convert 1-paged pdf to svg: <a href="">example</a></li><li><code>InkScape</code> should be able to do the same.</li></ul><h2>TypeScript - related stuff</h2></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdMeta":{"realpath":"/home/runner/work/jokester.github.io/jokester.github.io/posts/2017/2017-09-01-pdf-creation-in-browser.md","slug":["2017-09-01","pdf-creation-in-browser"],"frontMatter":{"title":"PDF creation in browser","publishAt":"2017-09-01"}},"mdContent":"\nWhen working on a svg-based document viewer in browser, I had a chance to make a pdf-export feature.\nThis post is a memo about caveats and findings in my quest.\n\n- toc\n  {:toc}\n\n## Background\n\nA brief \u003c!-- and NDA-compliant--\u003e introduction of the viewer I work on:\n\n- A multipage document viewer running in browser.\n- Each page may have a background image in svg format.\n- Each page may have multiple vector annotations: text / circle / rect / handdrawn track.\n- Annotations can be edited on the fly, and get synchronized between connected clients.\n\n## How to create pdf in browser\n\nWe used 2 libraries:\n\n- [devongovett/pdfkit](https://github.com/devongovett/pdfkit) to create pdf blob\n- [alafr/SVG-to-PDFKit](https://github.com/alafr/SVG-to-PDFKit) to draw svg image to pdf\n\n### bundle pdfkit for browser use\n\n- pdfkit has a [How to compile PDFKit for use in the browser](https://github.com/devongovett/pdfkit/wiki/How-to-compile-PDFKit-for-use-in-the-browser) guide in `github/pdfkit` wiki.\n  - We did not take this way: use of `browserify coffeeify` would make our build (currently webpack only) more complicated.\n- Or, use a webpack-only solution\n  - in short: we resolve module dependencies with webpack `transform-loader`\n  - some dependicies (that exists in node but not browser) are taken from [bpampuch/pdfmake](https://github.com/bpampuch/pdfmake)\n  - see my [jokester/random-hack](https://github.com/jokester/random-hack/tree/master/pdfkit-webpack) repo for a minimal working example.\n\n### draw svg to pdf\n\n- We used [alafr/SVG-to-PDFKit](https://github.com/alafr/SVG-to-PDFKit)\n  - internally, this library traversals DOM of svg and draws equivalent vector image with `pdfkit`.\n  - If the svg input is a string, a pure js svg parser will be used to build a DOM.\n    - This should work in both browser and node\n    - _Caveat_: this svg parser _does not_ recognize svg strings start with `\u003c?xml version=\"1.0\" encoding=\"UTF-8\"\u003e`. We have to strip this before passing it to `SVGtoPDF()`.\n    - _Note_: `style` attribute in svg string will not be intepreted. If your svg makes use of `style=`, you have to use `SVGElement` input and `useCSS` option. In that case SVG-to-PDFKit uses native `getComputedStyle` to have browser interprete the style.\n  - The svg input can also be a `SVGElement` object. Such objects can be obtained from `HTMLObjectElement#getSVGDocument()` `HTMLEmbedElement#getSVGDocument()` or [XMLHttpRequest](https://stackoverflow.com/a/14070928/327815).\n    - This likely requires a browser to work.\n    - _Caveat_: chrome may set incorrect prototype for native `SVGElement`, see [this issue](https://github.com/alafr/SVG-to-PDFKit/issues/47) for inspection and a workaround.\n\n### remove font data from pdfkit\n\n- pdfkit and dependencies have more than 1MB (almost not compressable) font data.\n- If you do not call `pdfDocument.text()`, they should be removed from JavaScript bundle.\n\n### draw not-in-font text to pdf\n\n### Browser compatibility\n\npdfkit needs some newer API to deal with binary data. Most browser (effectively everyone except IE) should work fine. The following list shows key features we needed.\n\n- `IE \u003e= 9`:\n  - Canvas: for bitmap drawing\n  - CSS (2d) transform: zoom and scroll DOM element with a transform matrix\n- `IE \u003e= 10`:\n  - Blob / ArrayBuffer / TypedArray: handle binary data in browser\n  - createObjectURL: can be used to cache arbitrary data (e.g. prefetched svg of all pages)\n    - Caveat: blob URLs in IE / Edge look like `blob:UUID`, and cannot be used as resource of object / embed elements.\n  - FileReader: read string or ArrayBuffer out of a Blob object\n\n### Reduce bundled size of pdfkit\n\n\u003c!-- TODO --\u003e\n\n## How to inspect / debug created pdf\n\n### By looking at pdf object\n\nThe Vector images are stored as _object_ in a pdf file.\nWe can read them after decoding them to textual form.\n\n- see [PDF Stream Objects](https://blog.didierstevens.com/2008/05/19/pdf-stream-objects/) for a brief introduction of encoded objects.\n- the decode can be done with `qpdf`: [example](https://stackoverflow.com/a/29474423/327815).\n\nReference:\n\n- [Understanding the PDF file format – How Are Images Stored](https://blog.idrsolutions.com/2010/04/understanding-the-pdf-file-format-how-are-images-stored/)\n- [apache fop](https://xmlgraphics.apache.org/fop/) is able to [embed svg in its own xml scheme](https://xmlgraphics.apache.org/fop/dev/fo/embedding.fo.pdf), that can be exported to pdf with fop itself.\n- [itext/rups](https://github.com/itext/rups/) PDF Inspection tool\n\n### By converting to svg again\n\nWe can also convert pdf to svg again, to see if that is correct (I found it much easier to inspect text and DOM of svg).\n\n- `pdfcairo` can convert 1-paged pdf to svg: [example]()\n- `InkScape` should be able to do the same.\n\n## TypeScript - related stuff\n"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2017-09-01","pdf-creation-in-browser"]},"buildId":"tlxtjnvNyuDsinQss6fzz","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["script",{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"}],["script",{"dangerouslySetInnerHTML":{"__html":"\n            window.dataLayer = window.dataLayer || [];\n            function gtag(){dataLayer.push(arguments);}\n            gtag('js', new Date());\n            gtag('config', 'UA-39627402-1', {\n              page_path: window.location.pathname,\n            });\n          "}}],["title",{"children":"PDF creation in browser"}],["meta",{"httpEquiv":"X-UA-Compatible","content":"IE=edge"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"}],["link",{"rel":"canonical","href":"https://jokester.github.io/posts/2017-09-01/pdf-creation-in-browser"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-555defa4e62ba07d4446.js"></script><script src="/_next/static/chunks/main-d42d109db6976c01a5e9.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" async=""></script><script src="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" async=""></script><script src="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" async=""></script><script src="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" async=""></script><script src="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" async=""></script><script src="/_next/static/tlxtjnvNyuDsinQss6fzz/_buildManifest.js" async=""></script><script src="/_next/static/tlxtjnvNyuDsinQss6fzz/_ssgManifest.js" async=""></script></body></html>