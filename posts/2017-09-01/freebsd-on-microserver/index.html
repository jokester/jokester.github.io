<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-39627402-1', {
              page_path: window.location.pathname,
            });
          </script><title>A home NAS server running FreeBSD</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"/><link rel="canonical" href="https://jokester.github.io/posts/2017-09-01/freebsd-on-microserver/"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/4aea23cc4ba74f25.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4aea23cc4ba74f25.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-3278669249d12298.js" defer=""></script><script src="/_next/static/chunks/framework-e6d86b677864e3f5.js" defer=""></script><script src="/_next/static/chunks/main-bd374c4482f3a8c9.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f13ade3d405e605a.js" defer=""></script><script src="/_next/static/chunks/782-c0d129453d73cf2f.js" defer=""></script><script src="/_next/static/chunks/503-60468e2aaeee9d33.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-0a158f9191a6a0a4.js" defer=""></script><script src="/_next/static/bu7HzLLYRJEipKxIoa-_x/_buildManifest.js" defer=""></script><script src="/_next/static/bu7HzLLYRJEipKxIoa-_x/_ssgManifest.js" defer=""></script></head><body class="overflow-y-scroll"><div id="__next"><div class="bg-black text-yellow-100"><div class="min-h-screen container mx-auto"><div class="px-4 py-1 flex items-center bg-gray-900 space-x-4 text-sm"><a class="sm:hidden text-lg" href="/">挖坑自動機</a><a class="hidden sm:inline-block text-lg" href="/">挖坑自動機 / Digging automaton</a><span>|</span><a class="text-yellow-200" href="/posts/">/posts</a><a class="" href="/works/">/works</a><a class="" href="/about/">/about</a></div><div class="px-4 pt-6"><div class="markdown"><h1></h1><hr/><div class="markdown"><p>This is a memo after installing FreeBSD on my MicroServer. Before that it was Arch Linux.</p>
<ul>
<li>toc
{:toc}</li>
</ul>
<h2>Hardware</h2>
<ul>
<li>HP MicroServer N54L (Gen7)</li>
<li>a handicapped N54L 2core cpu</li>
<li>2x8G ECC DDR3 memory<!-- -->
<ul>
<li>NOTE: N54L is picky about memory: it must be DDR3 ECC <em>unbuffered</em>. I found 2 economical modules on eBay at $50 / 8GB.</li>
</ul>
</li>
<li>1x256GB SSD for cache and performance-critical data<!-- -->
<ul>
<li>Connected to onboard SATA port (originally for CDROM)</li>
</ul>
</li>
<li>4x4TB HDDs for data<!-- -->
<ul>
<li>Connected to 4 HDD bays</li>
</ul>
</li>
<li>PCI-E addon cards:<!-- -->
<ul>
<li>ATI RV810 for HDMI output</li>
<li>Some USB3.0 interface card <!-- -->&lt;!-- TODO: what is the brand? --&gt;</li>
</ul>
</li>
</ul>
<h2>Install</h2>
<p>Nothing tricky, just boot from <code>FreeBSD-11.1-RELEASE-amd64-memstick.img</code> and go through the steps in installer.</p>
<ul>
<li>see <a href="https://wiki.freebsd.org/RootOnZFS">RootOnZFS</a> for an example of manual partitions</li>
<li>see <a href="https://www.freebsd.org/doc/en/articles/remote-install/installation.html">remote install</a> for guide on headless install</li>
</ul>
<h2>Hardware compatibility</h2>
<p>The only hardware-related issue is about DMA timeout messages in dmesg. They are SATA &quot;READ&quot; commands issued to the SSD but did not return in 5 seconds:</p>
<pre><code class="language-text">(ada3:ata2:0:1:0): READ_DMA. ACB: c8 00 80 30 3b 40 00 00 00 00 01 00
(ada3:ata2:0:1:0): CAM status: Command timeout
(ada3:ata2:0:1:0): Retrying command
</code></pre>
<p>This seemingly correlates to sys load, but nothing is wrong except the timeout itself (at least <code>smartctl</code> and <code>zpool scrub</code> zfs scrub says so).
There are <a href="https://forums.freenas.org/index.php?threads/daily-security-run-output-read_dma-command-timeout.26194/">similar problem reports</a>
and even <a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=195349">a merged patch</a>, however their workaround did not save me.</p>
<p>I found a possible explanation after days: the <code>hint.ahci.0.msi=&quot;1&quot;</code> helps when the disk is connected to AHCI controller 0, whereas my SSD was connected to a non-AHCI ATA controller.</p>
<p>A similar hint for <code>atapci.0</code> (<code>man ata (4)</code>) may have fixed this issue, but I went another way: to flash a custom BIOS firmware that enables AHCI on all SATA ports. After SSD is recognized as AHCI device (<code>ada3 at ahcich5 bus 0 scbus5 target 0 lun 0</code>), the timeout vanished.</p>
<p>References during my quest:</p>
<ul>
<li><a href="http://wiki.osdev.org/ATA/ATAPI_using_DMA#ATA.2FATAPI_Commands">how to decode DMA command</a></li>
<li><a href="https://ata.wiki.kernel.org/index.php/Libata_error_messages">how to read ATA error</a></li>
<li><a href="https://wiki.freebsd.org/JeremyChadwick/ATA_issues_and_troubleshooting">freebsd wiki / ata issues</a></li>
</ul>
<!-- -->&lt;!-- TODO: how to download / flash the custom firmware --&gt;<!-- -->
<h2>Post Install / Delay boot from USB root</h2>
<p>A <code>kern.cam.boot_delay</code> in <code>/boot/loader.conf</code> prevents system to boot from USB before it gets ready.</p>
<p><a href="http://web.mit.edu/freebsd/head/sys/boot/forth/loader.conf">an extensive example of loader.conf</a></p>
<h2>Post Install / Packages</h2>
<p>BSD have a binary package manager <code>pkg</code> now.</p>
<pre><code class="language-text"># pkg install                                   \
  bash zsh screen git coreutils rsync curl wget \
  sudo vim-lite cmake ruby devel/rubygems       \
  htop smartmontools ddrescue                   \
  vm-bhyve grub2-bhyve
</code></pre>
<p>(Binary packages constitutes a good example of the 20 / 80 rule. Personally I cannot recall a single time when I have to touch <code>make.conf</code> in my short Gentoo journey.)</p>
<!-- -->&lt;!-- TODO: add &#x27;basic&#x27; services: microcode update, etc --&gt;<!-- -->
<h2>Post Install / User and Group</h2>
<ul>
<li>create new user: <code>adduser</code> (interactive)</li>
<li>add new user to group: <code>pw group mod wheel -m MY_USERNAME</code></li>
</ul>
<h2>Post Install / Storage Pool</h2>
<p>My no.1 reason to change to FreeBSD is for ZFS. It seems to me that zfsonlinux still have a not-quite-short way to go.
The whole storage is like:</p>
<ul>
<li>a <code>syspo</code> zpool, created during install<!-- -->
<ul>
<li>contains a basic FreeBSD system</li>
<li>32GB of SSD, as a <code>log</code> vdev</li>
</ul>
</li>
<li>a <code>datapo</code> zpool<!-- -->
<ul>
<li>all 4x4TB HDDs, as a <code>raidz1</code> vdev</li>
<li>4GB of SSD, as a <code>log</code> vdev<!-- -->
<ul>
<li>used by zfs for ZIL</li>
</ul>
</li>
<li>128GB of SSD, as a <code>cache</code> vdev<!-- -->
<ul>
<li>will be used by zfs for L2ARC (cached IO, dedup table, etc)</li>
<li>the 4x4TB of data would make a DDT (dedup table) of around 100G</li>
</ul>
</li>
</ul>
</li>
<li>Rest of SSD is reserved, for ssd lifetime and future use</li>
</ul>
<p>ZFS settings and tuneables:</p>
<ul>
<li>enable <a href="http://www.schmidp.com/2014/01/07/zfs-full-disk-encryption-with-freebsd-10-part-2/">Encrypted</a>
<ul>
<li><a href="https://www.openattic.org/posts/unlock-geli-ecrypted-zfs-volume-freenas/">Unlock Geli-encrypted ZFS Volume - FreeNAS</a></li>
<li>Wanted [] as in zfsonlinux, sadly it&#x27;s not part of FreeBSD yet</li>
</ul>
</li>
<li>enable LZ4 <a href="https://www.freebsd.org/doc/handbook/zfs-term.html#zfs-term-compression-lz4">compreession</a>
<ul>
<li>lz4 / lz4fast saves like 0.5% - 0.8% <a href="https://gist.github.com/e921a4620fd8deec648d6b95b342e1ea">benchmark</a> with <a href="https://github.com/inikep/lzbench">lzbench</a></li>
<li><em>Risk</em>: my server is severly CPU bounded (N54L 2core/2.2G)</li>
<li>this can be always be disabled later: <a href="https://serverfault.com/q/499304/74190">https://serverfault.com/q/499304/74190</a></li>
</ul>
</li>
<li>enable <a href="http://constantin.glez.de/blog/2011/07/zfs-dedupe-or-not-dedupe">Dedupe</a>
<ul>
<li>a good BSD guy told me that dedup do save some space</li>
<li>I happen to have a SSD for L2ARC (dedup-table sizes at 5~6GB per TB data)</li>
<li><code>When in doubt, check how much</code> ... in <a href="https://wiki.freebsd.org/ZFSTuningGuide#Deduplication">ZFSTuningGuide</a></li>
</ul>
</li>
<li>cache stragegy: <code>all/all</code> for memory/L2ARC</li>
<li>scrub: once per week</li>
</ul>
<p>ZFS References:</p>
<ul>
<li><a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/zfs-term.html">FreeBSD handbook / zfs-term</a></li>
<li><a href="https://www.freebsd.org/doc/en/books/faq/all-about-zfs.html">FAQ: all-about-zfs</a></li>
<li><a href="https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/">ZFS Administration</a></li>
<li><a href="http://nex7.blogspot.jp/2013/03/readme1st.html">ZFS: Read Me 1st</a></li>
<li><a href="http://weblog.etherized.com/posts/185.html">Adventures in ZFS: arc, l2arc, dedupe, and streaming workloads</a></li>
<li><a href="https://blogs.oracle.com/jsavit/deduplication-now-in-zfs">Deduplication now in ZFS</a></li>
<li><a href="https://savagedlight.me/2012/07/15/freebsd-zfs-advanced-format/">FreeBSD ZFS: Advanced format (4k) drives and you</a></li>
<li>good bsd/zfs guys on IRC</li>
</ul>
<h2>Post Install / Services</h2>
<ul>
<li>
<p>Mail</p>
<ul>
<li>forward alert mail with mailgun: <a href="https://marblenix.com/blag/2017/08/20/Receiving-Email-Alerts-from-FreeBSD-using-Mailgun.html">guide</a></li>
<li>some <a href="https://www.digitalocean.com/community/tutorials/how-to-send-email-through-an-external-smtp-service-with-sendmail-on-freebsd-10-1">earlier guide</a> required sendmail to be recompiled. This is not the case today.</li>
</ul>
</li>
<li>
<p>Storage</p>
<ul>
<li>The data pool is exposed with samba</li>
</ul>
</li>
<li>
<p>VMs</p>
<ul>
<li><a href="https://github.com/churchers/vm-bhyve/wiki/Quickstart">vm-bhyve</a> works out of box for creating and managing VMs</li>
<li>All VMs uses bridged network and is now part of my home LAN</li>
<li>VM1: debian x64 for internal services</li>
<li>VM2: CoreOS for public services</li>
<li>VM3: archlinux playground (whole filesystem imported from old Arch Linux)</li>
</ul>
</li>
</ul>
<h2>Misc Tricks</h2>
<ul>
<li>We can <a href="https://tachibanatech.com/chris/freebsd/">access UFS from linux</a></li>
</ul></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdMeta":{"realpath":"/home/runner/work/jokester.github.io/jokester.github.io/posts/2017/2017-09-01-freebsd-on-microserver.md","slug":["2017-09-01","freebsd-on-microserver"],"frontMatter":{"title":"A home NAS server running FreeBSD","publishAt":"2017-09-01"}},"mdContent":"\nThis is a memo after installing FreeBSD on my MicroServer. Before that it was Arch Linux.\n\n- toc\n  {:toc}\n\n## Hardware\n\n- HP MicroServer N54L (Gen7)\n- a handicapped N54L 2core cpu\n- 2x8G ECC DDR3 memory\n  - NOTE: N54L is picky about memory: it must be DDR3 ECC _unbuffered_. I found 2 economical modules on eBay at \\$50 / 8GB.\n- 1x256GB SSD for cache and performance-critical data\n  - Connected to onboard SATA port (originally for CDROM)\n- 4x4TB HDDs for data\n  - Connected to 4 HDD bays\n- PCI-E addon cards:\n  - ATI RV810 for HDMI output\n  - Some USB3.0 interface card \u003c!-- TODO: what is the brand? --\u003e\n\n## Install\n\nNothing tricky, just boot from `FreeBSD-11.1-RELEASE-amd64-memstick.img` and go through the steps in installer.\n\n- see [RootOnZFS](https://wiki.freebsd.org/RootOnZFS) for an example of manual partitions\n- see [remote install](https://www.freebsd.org/doc/en/articles/remote-install/installation.html) for guide on headless install\n\n## Hardware compatibility\n\nThe only hardware-related issue is about DMA timeout messages in dmesg. They are SATA \"READ\" commands issued to the SSD but did not return in 5 seconds:\n\n```text\n(ada3:ata2:0:1:0): READ_DMA. ACB: c8 00 80 30 3b 40 00 00 00 00 01 00\n(ada3:ata2:0:1:0): CAM status: Command timeout\n(ada3:ata2:0:1:0): Retrying command\n```\n\nThis seemingly correlates to sys load, but nothing is wrong except the timeout itself (at least `smartctl` and `zpool scrub` zfs scrub says so).\nThere are [similar problem reports](https://forums.freenas.org/index.php?threads/daily-security-run-output-read_dma-command-timeout.26194/)\nand even [a merged patch](https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=195349), however their workaround did not save me.\n\nI found a possible explanation after days: the `hint.ahci.0.msi=\"1\"` helps when the disk is connected to AHCI controller 0, whereas my SSD was connected to a non-AHCI ATA controller.\n\nA similar hint for `atapci.0` (`man ata (4)`) may have fixed this issue, but I went another way: to flash a custom BIOS firmware that enables AHCI on all SATA ports. After SSD is recognized as AHCI device (`ada3 at ahcich5 bus 0 scbus5 target 0 lun 0`), the timeout vanished.\n\nReferences during my quest:\n\n- [how to decode DMA command](http://wiki.osdev.org/ATA/ATAPI_using_DMA#ATA.2FATAPI_Commands)\n- [how to read ATA error](https://ata.wiki.kernel.org/index.php/Libata_error_messages)\n- [freebsd wiki / ata issues](https://wiki.freebsd.org/JeremyChadwick/ATA_issues_and_troubleshooting)\n\u003c!-- TODO: how to download / flash the custom firmware --\u003e\n\n## Post Install / Delay boot from USB root\n\nA `kern.cam.boot_delay` in `/boot/loader.conf` prevents system to boot from USB before it gets ready.\n\n[an extensive example of loader.conf](http://web.mit.edu/freebsd/head/sys/boot/forth/loader.conf)\n\n## Post Install / Packages\n\nBSD have a binary package manager `pkg` now.\n\n```text\n# pkg install                                   \\\n  bash zsh screen git coreutils rsync curl wget \\\n  sudo vim-lite cmake ruby devel/rubygems       \\\n  htop smartmontools ddrescue                   \\\n  vm-bhyve grub2-bhyve\n```\n\n(Binary packages constitutes a good example of the 20 / 80 rule. Personally I cannot recall a single time when I have to touch `make.conf` in my short Gentoo journey.)\n\n\u003c!-- TODO: add 'basic' services: microcode update, etc --\u003e\n\n## Post Install / User and Group\n\n- create new user: `adduser` (interactive)\n- add new user to group: `pw group mod wheel -m MY_USERNAME`\n\n## Post Install / Storage Pool\n\nMy no.1 reason to change to FreeBSD is for ZFS. It seems to me that zfsonlinux still have a not-quite-short way to go.\nThe whole storage is like:\n\n- a `syspo` zpool, created during install\n  - contains a basic FreeBSD system\n  - 32GB of SSD, as a `log` vdev\n- a `datapo` zpool\n  - all 4x4TB HDDs, as a `raidz1` vdev\n  - 4GB of SSD, as a `log` vdev\n    - used by zfs for ZIL\n  - 128GB of SSD, as a `cache` vdev\n    - will be used by zfs for L2ARC (cached IO, dedup table, etc)\n    - the 4x4TB of data would make a DDT (dedup table) of around 100G\n- Rest of SSD is reserved, for ssd lifetime and future use\n\nZFS settings and tuneables:\n\n- enable [Encrypted](http://www.schmidp.com/2014/01/07/zfs-full-disk-encryption-with-freebsd-10-part-2/)\n  - [Unlock Geli-encrypted ZFS Volume - FreeNAS](https://www.openattic.org/posts/unlock-geli-ecrypted-zfs-volume-freenas/)\n  - Wanted [] as in zfsonlinux, sadly it's not part of FreeBSD yet\n- enable LZ4 [compreession](https://www.freebsd.org/doc/handbook/zfs-term.html#zfs-term-compression-lz4)\n  - lz4 / lz4fast saves like 0.5% - 0.8% [benchmark](https://gist.github.com/e921a4620fd8deec648d6b95b342e1ea) with [lzbench](https://github.com/inikep/lzbench)\n  - _Risk_: my server is severly CPU bounded (N54L 2core/2.2G)\n  - this can be always be disabled later: https://serverfault.com/q/499304/74190\n- enable [Dedupe](http://constantin.glez.de/blog/2011/07/zfs-dedupe-or-not-dedupe)\n  - a good BSD guy told me that dedup do save some space\n  - I happen to have a SSD for L2ARC (dedup-table sizes at 5~6GB per TB data)\n  - `When in doubt, check how much` ... in [ZFSTuningGuide](https://wiki.freebsd.org/ZFSTuningGuide#Deduplication)\n- cache stragegy: `all/all` for memory/L2ARC\n- scrub: once per week\n\nZFS References:\n\n- [FreeBSD handbook / zfs-term](https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/zfs-term.html)\n- [FAQ: all-about-zfs](https://www.freebsd.org/doc/en/books/faq/all-about-zfs.html)\n- [ZFS Administration](https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/)\n- [ZFS: Read Me 1st](http://nex7.blogspot.jp/2013/03/readme1st.html)\n- [Adventures in ZFS: arc, l2arc, dedupe, and streaming workloads](http://weblog.etherized.com/posts/185.html)\n- [Deduplication now in ZFS](https://blogs.oracle.com/jsavit/deduplication-now-in-zfs)\n- [FreeBSD ZFS: Advanced format (4k) drives and you](https://savagedlight.me/2012/07/15/freebsd-zfs-advanced-format/)\n- good bsd/zfs guys on IRC\n\n## Post Install / Services\n\n- Mail\n\n  - forward alert mail with mailgun: [guide](https://marblenix.com/blag/2017/08/20/Receiving-Email-Alerts-from-FreeBSD-using-Mailgun.html)\n  - some [earlier guide](https://www.digitalocean.com/community/tutorials/how-to-send-email-through-an-external-smtp-service-with-sendmail-on-freebsd-10-1) required sendmail to be recompiled. This is not the case today.\n\n- Storage\n\n  - The data pool is exposed with samba\n\n- VMs\n  - [vm-bhyve](https://github.com/churchers/vm-bhyve/wiki/Quickstart) works out of box for creating and managing VMs\n  - All VMs uses bridged network and is now part of my home LAN\n  - VM1: debian x64 for internal services\n  - VM2: CoreOS for public services\n  - VM3: archlinux playground (whole filesystem imported from old Arch Linux)\n\n## Misc Tricks\n\n- We can [access UFS from linux](https://tachibanatech.com/chris/freebsd/)\n"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2017-09-01","freebsd-on-microserver"]},"buildId":"bu7HzLLYRJEipKxIoa-_x","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>