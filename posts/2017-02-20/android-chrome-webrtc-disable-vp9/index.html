<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-39627402-1', {
              page_path: window.location.pathname,
            });
          </script><title>Disabling VP9 in Android Chrome&#x27;s WebRTC</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"/><link rel="canonical" href="https://jokester.github.io/posts/2017-02-20/android-chrome-webrtc-disable-vp9/"/><meta name="next-head-count" content="7"/><link rel="preload" href="/_next/static/css/4aea23cc4ba74f25.css" as="style"/><link rel="stylesheet" href="/_next/static/css/4aea23cc4ba74f25.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-3278669249d12298.js" defer=""></script><script src="/_next/static/chunks/framework-e6d86b677864e3f5.js" defer=""></script><script src="/_next/static/chunks/main-bd374c4482f3a8c9.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f13ade3d405e605a.js" defer=""></script><script src="/_next/static/chunks/782-c0d129453d73cf2f.js" defer=""></script><script src="/_next/static/chunks/503-60468e2aaeee9d33.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-0a158f9191a6a0a4.js" defer=""></script><script src="/_next/static/79WDPIk9zHGAsq-WoX9nZ/_buildManifest.js" defer=""></script><script src="/_next/static/79WDPIk9zHGAsq-WoX9nZ/_ssgManifest.js" defer=""></script></head><body class="overflow-y-scroll"><div id="__next"><div class="bg-black text-yellow-100"><div class="min-h-screen container mx-auto"><div class="px-4 py-1 flex items-center bg-gray-900 space-x-4 text-sm"><a class="sm:hidden text-lg" href="/">挖坑自動機</a><a class="hidden sm:inline-block text-lg" href="/">挖坑自動機 / Digging automaton</a><span>|</span><a class="text-yellow-200" href="/posts/">/posts</a><a class="" href="/works/">/works</a><a class="" href="/about/">/about</a></div><div class="px-4 pt-6"><div class="markdown"><h1></h1><hr/><div class="markdown"><ul>
<li>toc
{:toc}</li>
</ul>
<p>NOTE: due to complexity and opaqueness (to a JavaScript developer) of WebRTC technologies, this may not be a complete solution.
You are advised to test and benchmark thorough before using this hack in real product.</p>
<h3>Problem: encoding with VP9 can cause high CPU load in an old tablet</h3>
<p>The problem happened with a Lenovo YOGA tablet and its ARMv7 MSM8909 processor.</p>
<p>When a video is being send to the other browse, the FPS of all videos falls to less than 1.</p>
<p>We finally located the direct cause of CPU load: encoding video stream in VP9 took <code>400 ~ 600ms</code> per frame (the avarage encode time can be found in <code>chrome://webrtc-internals</code>).</p>
<h3>Fix: force Chrome to use VP8</h3>
<p>Local offer SDP lists video formats that can be used in RTCPeerConnection.
If we remove VP9 from SDP before passing it to <code>peerConn.setLocalDescription()</code>, Chrome will use other codecs instead.</p>
<p>I am attaching an example SDP got from <a href="https://webrtc.github.io/samples/src/content/peerconnection/munge-sdp/">WebRTC samples Munge SDP</a>.
Changes are listed in <code>diff</code> format. Lines started with <code>!</code> are comments and not part of SDP.</p>
<pre><code class="language-diff">--- original SDP got from peerConn.createOffer()
+++ new SDP to use in peerConn.setLocalDescription()
 v=0
 o=- 1663534131550752306 2 IN IP4 127.0.0.1
 s=-
 t=0 0
 a=group:BUNDLE audio video data
 a=msid-semantic: WMS NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs
 m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 106 105 13 126
 c=IN IP4 0.0.0.0
 a=rtcp:9 IN IP4 0.0.0.0
 a=ice-ufrag:VoeE
 a=ice-pwd:ZMrKM1piGvOdgZxVOOLlMOMq
 a=fingerprint:sha-256 00:3A:44:D4:B6:9D:8D:88:87:84:F8:18:29:8F:64:E8:AE:59:3E:D6:33:6C:74:88:4D:F8:88:1C:0E:C6:48:F9
 a=setup:actpass
 a=mid:audio
 a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level
 a=sendrecv
 a=rtcp-mux
 a=rtpmap:111 opus/48000/2
 a=rtcp-fb:111 transport-cc
 a=fmtp:111 minptime=10;useinbandfec=1
 a=rtpmap:103 ISAC/16000
 a=rtpmap:104 ISAC/32000
 a=rtpmap:9 G722/8000
 a=rtpmap:0 PCMU/8000
 a=rtpmap:8 PCMA/8000
 a=rtpmap:106 CN/32000
 a=rtpmap:105 CN/16000
 a=rtpmap:13 CN/8000
 a=rtpmap:126 telephone-event/8000
 a=ssrc:795782633 cname:/nX1r0P1oSOr0ktw
 a=ssrc:795782633 msid:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs 44267d8c-e64a-4c3c-b40f-975dfa4a5ea4
 a=ssrc:795782633 mslabel:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs
 a=ssrc:795782633 label:44267d8c-e64a-4c3c-b40f-975dfa4a5ea4
! &quot;m=&quot; denotes &quot;Media Descriptions&quot;.
! The numbers 100 101 ... are &quot;payload type number&quot; that are used to index payload.
! We are removing 101, the payload type number of VP9 here
-m=video 9 UDP/TLS/RTP/SAVPF 100 101 107 116 117 96 97 99 98
+m=video 9 UDP/TLS/RTP/SAVPF 100 107 116 117 96 97 99 98
 c=IN IP4 0.0.0.0
 a=rtcp:9 IN IP4 0.0.0.0
 a=ice-ufrag:VoeE
 a=ice-pwd:ZMrKM1piGvOdgZxVOOLlMOMq
 a=fingerprint:sha-256 00:3A:44:D4:B6:9D:8D:88:87:84:F8:18:29:8F:64:E8:AE:59:3E:D6:33:6C:74:88:4D:F8:88:1C:0E:C6:48:F9
 a=setup:actpass
 a=mid:video
 a=extmap:2 urn:ietf:params:rtp-hdrext:toffset
 a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
 a=extmap:4 urn:3gpp:video-orientation
 a=extmap:5 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01
 a=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay
 a=sendrecv
 a=rtcp-mux
 a=rtcp-rsize
 a=rtpmap:100 VP8/90000
 a=rtcp-fb:100 ccm fir
 a=rtcp-fb:100 nack
 a=rtcp-fb:100 nack pli
 a=rtcp-fb:100 goog-remb
 a=rtcp-fb:100 transport-cc
! &quot;a=&quot; are attributes associated with each payload type number
! this tells us that 101 is the payload type number to remove
-a=rtpmap:101 VP9/90000
-a=rtcp-fb:101 ccm fir
-a=rtcp-fb:101 nack
-a=rtcp-fb:101 nack pli
-a=rtcp-fb:101 goog-remb
-a=rtcp-fb:101 transport-cc
 a=rtpmap:107 H264/90000
 a=rtcp-fb:107 ccm fir
 a=rtcp-fb:107 nack
 a=rtcp-fb:107 nack pli
 a=rtcp-fb:107 goog-remb
 a=rtcp-fb:107 transport-cc
 a=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f
 a=rtpmap:116 red/90000
 a=rtpmap:117 ulpfec/90000
 a=rtpmap:96 rtx/90000
 a=fmtp:96 apt=100
 a=rtpmap:97 rtx/90000
! &quot;a=fmtp&quot; attribute is described in RFC4588
! In short, apt=101 referes to previous VP9 payload type.
! We are changing it to 100 (VP8 payload) here.
-a=fmtp:97 apt=101
+a=fmtp:97 apt=100
 a=rtpmap:99 rtx/90000
 a=fmtp:99 apt=107
 a=rtpmap:98 rtx/90000
 a=fmtp:98 apt=116
 a=ssrc-group:FID 1412078074 1853322751
 a=ssrc:1412078074 cname:/nX1r0P1oSOr0ktw
 a=ssrc:1412078074 msid:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs 8d3831fd-53dd-464a-8a24-0b21f2465e3d
 a=ssrc:1412078074 mslabel:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs
 a=ssrc:1412078074 label:8d3831fd-53dd-464a-8a24-0b21f2465e3d
 a=ssrc:1853322751 cname:/nX1r0P1oSOr0ktw
 a=ssrc:1853322751 msid:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs 8d3831fd-53dd-464a-8a24-0b21f2465e3d
 a=ssrc:1853322751 mslabel:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs
 a=ssrc:1853322751 label:8d3831fd-53dd-464a-8a24-0b21f2465e3d
 m=application 9 DTLS/SCTP 5000
 c=IN IP4 0.0.0.0
 a=ice-ufrag:VoeE
 a=ice-pwd:ZMrKM1piGvOdgZxVOOLlMOMq
 a=fingerprint:sha-256 00:3A:44:D4:B6:9D:8D:88:87:84:F8:18:29:8F:64:E8:AE:59:3E:D6:33:6C:74:88:4D:F8:88:1C:0E:C6:48:F9
 a=setup:actpass
 a=mid:data
 a=sctpmap:5000 webrtc-datachannel 1024
</code></pre>
<p>Also note that if you split SDP string into lines, they should be joined with <code>\r\n</code>.
This is stated in <a href="https://tools.ietf.org/html/rfc4566">RFC4566: SDP</a> (<code>The sequence CRLF (0x0d0a) is used to end a record, blah</code>). Missed it in my first try.</p>
<p>We decided to use VP8 because it should almost be available.
<a href="https://source.android.com/compatibility/android-cdd.html#5_1_3_video_codecs">Android Compatibility Definition Document</a>
says that all devices with Android <code>&gt;= 4.3</code> is <em>required</em> to have VP8 encoder.</p>
<h3>Caveats / TBD</h3>
<p>Editing SDP worked for me, but this is far from a perfect fix. To name a few:</p>
<ul>
<li>VP9 is stated to save 30% of bandwidth than VP8 (<a href="https://developers.google.com/web/updates/2016/01/vp9-webrtc">src</a>).</li>
<li>I did not find a way to detect hardware encoding capability in mobile browser (any browser actually). The best workaround I could think of is to apply this hack to <em>all</em> Android Chrome versions.</li>
</ul>
<h3>Reference</h3>
<ul>
<li><a href="http://wiki.webmproject.org/hardware/socs">SoCs Supporting VP8/VP9</a></li>
<li><a href="https://tools.ietf.org/html/rfc4566">RFC4566 / SDP</a></li>
<li><a href="https://tools.ietf.org/html/rfc4588">RFC4588 / RTP Retransmission Payload Format</a></li>
</ul></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdMeta":{"realpath":"/home/runner/work/jokester.github.io/jokester.github.io/posts/2017/2017-02-20-android-chrome-webrtc-disable-vp9.md","slug":["2017-02-20","android-chrome-webrtc-disable-vp9"],"frontMatter":{"title":"Disabling VP9 in Android Chrome's WebRTC","publishAt":"2017-02-20"}},"mdContent":"\n- toc\n  {:toc}\n\nNOTE: due to complexity and opaqueness (to a JavaScript developer) of WebRTC technologies, this may not be a complete solution.\nYou are advised to test and benchmark thorough before using this hack in real product.\n\n### Problem: encoding with VP9 can cause high CPU load in an old tablet\n\nThe problem happened with a Lenovo YOGA tablet and its ARMv7 MSM8909 processor.\n\nWhen a video is being send to the other browse, the FPS of all videos falls to less than 1.\n\nWe finally located the direct cause of CPU load: encoding video stream in VP9 took `400 ~ 600ms` per frame (the avarage encode time can be found in `chrome://webrtc-internals`).\n\n### Fix: force Chrome to use VP8\n\nLocal offer SDP lists video formats that can be used in RTCPeerConnection.\nIf we remove VP9 from SDP before passing it to `peerConn.setLocalDescription()`, Chrome will use other codecs instead.\n\nI am attaching an example SDP got from [WebRTC samples Munge SDP](https://webrtc.github.io/samples/src/content/peerconnection/munge-sdp/).\nChanges are listed in `diff` format. Lines started with `!` are comments and not part of SDP.\n\n```diff\n--- original SDP got from peerConn.createOffer()\n+++ new SDP to use in peerConn.setLocalDescription()\n v=0\n o=- 1663534131550752306 2 IN IP4 127.0.0.1\n s=-\n t=0 0\n a=group:BUNDLE audio video data\n a=msid-semantic: WMS NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs\n m=audio 9 UDP/TLS/RTP/SAVPF 111 103 104 9 0 8 106 105 13 126\n c=IN IP4 0.0.0.0\n a=rtcp:9 IN IP4 0.0.0.0\n a=ice-ufrag:VoeE\n a=ice-pwd:ZMrKM1piGvOdgZxVOOLlMOMq\n a=fingerprint:sha-256 00:3A:44:D4:B6:9D:8D:88:87:84:F8:18:29:8F:64:E8:AE:59:3E:D6:33:6C:74:88:4D:F8:88:1C:0E:C6:48:F9\n a=setup:actpass\n a=mid:audio\n a=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\n a=sendrecv\n a=rtcp-mux\n a=rtpmap:111 opus/48000/2\n a=rtcp-fb:111 transport-cc\n a=fmtp:111 minptime=10;useinbandfec=1\n a=rtpmap:103 ISAC/16000\n a=rtpmap:104 ISAC/32000\n a=rtpmap:9 G722/8000\n a=rtpmap:0 PCMU/8000\n a=rtpmap:8 PCMA/8000\n a=rtpmap:106 CN/32000\n a=rtpmap:105 CN/16000\n a=rtpmap:13 CN/8000\n a=rtpmap:126 telephone-event/8000\n a=ssrc:795782633 cname:/nX1r0P1oSOr0ktw\n a=ssrc:795782633 msid:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs 44267d8c-e64a-4c3c-b40f-975dfa4a5ea4\n a=ssrc:795782633 mslabel:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs\n a=ssrc:795782633 label:44267d8c-e64a-4c3c-b40f-975dfa4a5ea4\n! \"m=\" denotes \"Media Descriptions\".\n! The numbers 100 101 ... are \"payload type number\" that are used to index payload.\n! We are removing 101, the payload type number of VP9 here\n-m=video 9 UDP/TLS/RTP/SAVPF 100 101 107 116 117 96 97 99 98\n+m=video 9 UDP/TLS/RTP/SAVPF 100 107 116 117 96 97 99 98\n c=IN IP4 0.0.0.0\n a=rtcp:9 IN IP4 0.0.0.0\n a=ice-ufrag:VoeE\n a=ice-pwd:ZMrKM1piGvOdgZxVOOLlMOMq\n a=fingerprint:sha-256 00:3A:44:D4:B6:9D:8D:88:87:84:F8:18:29:8F:64:E8:AE:59:3E:D6:33:6C:74:88:4D:F8:88:1C:0E:C6:48:F9\n a=setup:actpass\n a=mid:video\n a=extmap:2 urn:ietf:params:rtp-hdrext:toffset\n a=extmap:3 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\n a=extmap:4 urn:3gpp:video-orientation\n a=extmap:5 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\n a=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay\n a=sendrecv\n a=rtcp-mux\n a=rtcp-rsize\n a=rtpmap:100 VP8/90000\n a=rtcp-fb:100 ccm fir\n a=rtcp-fb:100 nack\n a=rtcp-fb:100 nack pli\n a=rtcp-fb:100 goog-remb\n a=rtcp-fb:100 transport-cc\n! \"a=\" are attributes associated with each payload type number\n! this tells us that 101 is the payload type number to remove\n-a=rtpmap:101 VP9/90000\n-a=rtcp-fb:101 ccm fir\n-a=rtcp-fb:101 nack\n-a=rtcp-fb:101 nack pli\n-a=rtcp-fb:101 goog-remb\n-a=rtcp-fb:101 transport-cc\n a=rtpmap:107 H264/90000\n a=rtcp-fb:107 ccm fir\n a=rtcp-fb:107 nack\n a=rtcp-fb:107 nack pli\n a=rtcp-fb:107 goog-remb\n a=rtcp-fb:107 transport-cc\n a=fmtp:107 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\n a=rtpmap:116 red/90000\n a=rtpmap:117 ulpfec/90000\n a=rtpmap:96 rtx/90000\n a=fmtp:96 apt=100\n a=rtpmap:97 rtx/90000\n! \"a=fmtp\" attribute is described in RFC4588\n! In short, apt=101 referes to previous VP9 payload type.\n! We are changing it to 100 (VP8 payload) here.\n-a=fmtp:97 apt=101\n+a=fmtp:97 apt=100\n a=rtpmap:99 rtx/90000\n a=fmtp:99 apt=107\n a=rtpmap:98 rtx/90000\n a=fmtp:98 apt=116\n a=ssrc-group:FID 1412078074 1853322751\n a=ssrc:1412078074 cname:/nX1r0P1oSOr0ktw\n a=ssrc:1412078074 msid:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs 8d3831fd-53dd-464a-8a24-0b21f2465e3d\n a=ssrc:1412078074 mslabel:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs\n a=ssrc:1412078074 label:8d3831fd-53dd-464a-8a24-0b21f2465e3d\n a=ssrc:1853322751 cname:/nX1r0P1oSOr0ktw\n a=ssrc:1853322751 msid:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs 8d3831fd-53dd-464a-8a24-0b21f2465e3d\n a=ssrc:1853322751 mslabel:NFf4pxQvqNFomEdHC0fI1kwlxx5O9NbeAUUs\n a=ssrc:1853322751 label:8d3831fd-53dd-464a-8a24-0b21f2465e3d\n m=application 9 DTLS/SCTP 5000\n c=IN IP4 0.0.0.0\n a=ice-ufrag:VoeE\n a=ice-pwd:ZMrKM1piGvOdgZxVOOLlMOMq\n a=fingerprint:sha-256 00:3A:44:D4:B6:9D:8D:88:87:84:F8:18:29:8F:64:E8:AE:59:3E:D6:33:6C:74:88:4D:F8:88:1C:0E:C6:48:F9\n a=setup:actpass\n a=mid:data\n a=sctpmap:5000 webrtc-datachannel 1024\n```\n\nAlso note that if you split SDP string into lines, they should be joined with `\\r\\n`.\nThis is stated in [RFC4566: SDP](https://tools.ietf.org/html/rfc4566) (`The sequence CRLF (0x0d0a) is used to end a record, blah`). Missed it in my first try.\n\nWe decided to use VP8 because it should almost be available.\n[Android Compatibility Definition Document](https://source.android.com/compatibility/android-cdd.html#5_1_3_video_codecs)\nsays that all devices with Android `\u003e= 4.3` is _required_ to have VP8 encoder.\n\n### Caveats / TBD\n\nEditing SDP worked for me, but this is far from a perfect fix. To name a few:\n\n- VP9 is stated to save 30% of bandwidth than VP8 ([src](https://developers.google.com/web/updates/2016/01/vp9-webrtc)).\n- I did not find a way to detect hardware encoding capability in mobile browser (any browser actually). The best workaround I could think of is to apply this hack to _all_ Android Chrome versions.\n\n### Reference\n\n- [SoCs Supporting VP8/VP9](http://wiki.webmproject.org/hardware/socs)\n- [RFC4566 / SDP](https://tools.ietf.org/html/rfc4566)\n- [RFC4588 / RTP Retransmission Payload Format](https://tools.ietf.org/html/rfc4588)\n"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2017-02-20","android-chrome-webrtc-disable-vp9"]},"buildId":"79WDPIk9zHGAsq-WoX9nZ","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>