<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-39627402-1', {
              page_path: window.location.pathname,
            });
          </script><title>Setup Archlinux on Raspberry Pi 4b</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"/><link rel="canonical" href="https://jokester.github.io/posts/2019-09-14/setup-archlinux-raspberry-pi-4b"/><link rel="preload" href="/_next/static/css/cbf8b5770f5f30aa7698.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cbf8b5770f5f30aa7698.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-d42d109db6976c01a5e9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" as="script"/><link rel="preload" href="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" as="script"/></head><body class="overflow-y-scroll"><div id="__next"><div class="bg-black text-yellow-100"><div class="min-h-screen container mx-auto"><div class="px-4 py-1 flex items-center bg-gray-900 space-x-4 text-sm"><a class="sm:hidden text-lg" href="/">挖坑自動機</a><a class="hidden sm:inline-block text-lg" href="/">挖坑自動機 / Digging automaton</a><span>|</span><a class="text-yellow-200" href="/posts/">/posts</a><a class="" href="/works/">/works</a><a class="" href="/about/">/about</a></div><div class="px-4 pt-6"><div class="markdown"><h1></h1><hr/><div class="markdown"><p>I bought a raspberry 4b (4g mem) to use as a low-power home server and emulator console (<a href="https://www.archlinux.org/groups/x86_64/libretro/">libretro</a>). By far I&#x27;m satisfied.</p><p>This is a memo about my settings and tunings.</p><ul><li>toc
{:toc}</li></ul><h2>Prepare SD card</h2><p>I started from <a href="https://archlinuxarm.org/about/downloads">the build at ArchLinuxARM</a> but used a btrfs root instead of ext4.</p><p>The <a href="https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-4">original instructions used ext4</a>
should definitely work. It&#x27;s just I prefer to use a btrfs subvolume as root for a few reasons:</p><ul><li>transparent compression (makes the SD card less of a bottleneck)</li><li>subvolume snapshots (enables convenient transfer with <code>btrfs send/receive</code>, and backup like <a href="https://github.com/digint/btrbk">btrbk</a>)</li></ul><p>The following snippet assumes SD card is at <code>/dev/sdX</code>. You need to use actual path in commands.</p><h3>Partition the card</h3><p>With <code>fdisk</code> or other tools you like:</p><ul><li>Create <code>sdX1</code>, a 100MB FAT partition, and set partition type to <code>W95 FAT32 (LBA)</code>. This becomes <code>/boot</code>.</li><li>Create <code>sdX2</code> with rest of the disk, and set partition type to <code>Linux</code>. This becomes parent of other subvolumes including <code>/</code> (detailed later).</li><li>If swap space is required (think twice, it&#x27;s SD card after all), shrink <code>sdX2</code> and create a swap partition now, because swap file is not supported in btrfs.</li></ul><p>Refer to original instructions if you are uncertain about <code>fdisk</code> commands.</p><h3>mkfs and extract image</h3><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span># cd /media
</span>
<!-- --># mkfs.vfat  /dev/sdX1
<!-- -->
<!-- --># mkfs.btrfs /dev/sdX2
<!-- -->
<!-- --># mkdir -pv sdcard
<!-- -->
<!-- --># mount /dev/sdX2 sdcard -o ssd,discard,compress=lzo
<!-- -->
<!-- --># btrfs subvolume create sdcard/root-current         # This subvolume becomes / at run time. It can be snapshot-ed separately.
<!-- -->
<!-- --># mkdir sdcard/root-current/boot
<!-- -->
<!-- --># mount /dev/sdX1 sdcard/root-current/boot
<!-- -->
<!-- --># bsdtar -xpf ArchLinuxARM-rpi-4-latest.tar.gz -C sdcard/root-current
</code></pre><h3>configure mounts</h3><p>Edit <code>sdcard/root-current/boot/cmdline.txt</code>, add <code>rootflags</code> part to mount the subvolume at <code>/</code>:</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code class="language-diff" style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token deleted-sign prefix" style="color:#f92672">-</span><span class="token deleted-sign line" style="color:#f92672">root=/dev/mmcblk0p2 rw rootwait console=ttyAMA0,115200 ...
</span><span class="token deleted-sign line" style="color:#f92672"></span><span class="token inserted-sign prefix" style="color:#A8FF60">+</span><span class="token inserted-sign line" style="color:#A8FF60">root=/dev/mmcblk0p2 rootflags=subvol=/root-current rw rootwait console=ttyAMA0,115200 ...</span></code></pre><p>Edit <code>sdcard/root-current/etc/fstab</code>, add our mount options (it boots without these lines, but new created files won&#x27;t get compressed):</p><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code class="language-diff" style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token inserted-sign prefix" style="color:#A8FF60">+</span><span class="token inserted-sign line" style="color:#A8FF60">/dev/mmcblk0p2  /              btrfs   defaults,compress=lzo,subvol=/root-current       0       0
</span><span class="token inserted-sign line" style="color:#A8FF60"></span><span class="token inserted-sign prefix" style="color:#A8FF60">+</span><span class="token inserted-sign line" style="color:#A8FF60">/dev/mmcblk0p2  /media/sdcard  btrfs   defaults,compress=lzo,subvol=/,noauto            0       0</span></code></pre><p>The <code>/media/sdcard</code> mount is not necessary for everyday use. It can be used to manage subvolumes / snapshots.</p><h2>Customization and hardening</h2><p>After successfully booting from SD card:</p><ul><li>Modify <code>/etc/locale.gen</code> and re-run <code>locale-gen</code> (It&#x27;s strange that the <code>locale.gen</code> does not come with any locale.)</li><li>Recommended: harden sshd and other security config</li></ul><h2>Tuneables to minimize SD card IO</h2><p>After the following attempts, I&#x27;m already OK with the performance. Stopping here until I need to squeeze more out of it.</p><h3>Mount options</h3><ul><li>vfat partition: <code>noatime,nodiratime</code></li><li>btrfs partition: <code>noatime,nodiratime,compress=lzo,ssd,discard</code></li></ul><h3>Stop journald from persisting logs</h3><pre style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em;background:#1d1f21"><code class="language-diff" style="color:#c5c8c6;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Inconsolata, Monaco, Consolas, &#x27;Courier New&#x27;, Courier, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span># /etc/systemd/journald.conf
</span><span></span><span class="token unchanged prefix"> </span><span class="token unchanged line">[Journal]
</span><span class="token unchanged line"></span><span class="token deleted-sign prefix" style="color:#f92672">-</span><span class="token deleted-sign line" style="color:#f92672">Storage=auto
</span><span class="token deleted-sign line" style="color:#f92672"></span><span class="token inserted-sign prefix" style="color:#A8FF60">+</span><span class="token inserted-sign line" style="color:#A8FF60">Storage=volatile</span></code></pre><h2>Mount remote disk via iSCSI</h2><p>This is my first journey about iSCSI but it&#x27;s smoother than I thought.</p><h3>Server aka &quot;iSCSI target&quot;</h3><p><a href="/post/2017-09/freebsd-on-microserver/">My NAS</a> runs FreeBSD so I just followed the <a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/network-iscsi.html">29.12.1. Configuring an iSCSI Target</a>.</p><h3>Client aka &quot;iSCSI Initiator&quot;</h3><p>see <a href="https://wiki.archlinux.org/index.php/Open-iSCSI">archwiki</a></p><h2>Gaming stuff: libretro and joystick</h2><p>TODO</p><h2>Watchlist</h2><h3>ARMv8 build</h3><p>The CPU is ARMv8-capable but I don&#x27;t see any ARMv8 builds published. Guess I have to check the following links later:</p><ul><li><a href="https://www.raspberrypi.org/forums/viewtopic.php?t=245658">Stable 64 bit (arm v8) Raspbian buster on pi 4?</a> @ raspberrypi.org</li><li><a href="https://archlinuxarm.org/forum/viewtopic.php?f=8&amp;t=13734&amp;start=50">what about PI 4</a> @ archlinuxarm.org</li><li><a href="https://github.com/lategoodbye/rpi-zero/issues/43">Upstream initial Raspberry Pi 4 B support</a> @ github</li></ul></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdMeta":{"realpath":"/home/runner/work/jokester.github.io/jokester.github.io/posts/2019/2019-09-14-setup-archlinux-raspberry-pi-4b.md","slug":["2019-09-14","setup-archlinux-raspberry-pi-4b"],"frontMatter":{"title":"Setup Archlinux on Raspberry Pi 4b","publishAt":"2019-09-14"}},"mdContent":"\nI bought a raspberry 4b (4g mem) to use as a low-power home server and emulator console ([libretro](https://www.archlinux.org/groups/x86_64/libretro/)). By far I'm satisfied.\n\nThis is a memo about my settings and tunings.\n\n* toc\n{:toc}\n\n## Prepare SD card\n\nI started from [the build at ArchLinuxARM](https://archlinuxarm.org/about/downloads) but used a btrfs root instead of ext4.\n\nThe [original instructions used ext4](https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-4)\nshould definitely work. It's just I prefer to use a btrfs subvolume as root for a few reasons:\n\n- transparent compression (makes the SD card less of a bottleneck)\n- subvolume snapshots (enables convenient transfer with `btrfs send/receive`, and backup like [btrbk](https://github.com/digint/btrbk))\n\nThe following snippet assumes SD card is at `/dev/sdX`. You need to use actual path in commands.\n\n### Partition the card\n\nWith `fdisk` or other tools you like:\n\n- Create `sdX1`, a 100MB FAT partition, and set partition type to `W95 FAT32 (LBA)`. This becomes `/boot`.\n- Create `sdX2` with rest of the disk, and set partition type to `Linux`. This becomes parent of other subvolumes including `/` (detailed later).\n- If swap space is required (think twice, it's SD card after all), shrink `sdX2` and create a swap partition now, because swap file is not supported in btrfs.\n\nRefer to original instructions if you are uncertain about `fdisk` commands.\n\n### mkfs and extract image\n\n```\n# cd /media\n\n# mkfs.vfat  /dev/sdX1\n\n# mkfs.btrfs /dev/sdX2\n\n# mkdir -pv sdcard\n\n# mount /dev/sdX2 sdcard -o ssd,discard,compress=lzo\n\n# btrfs subvolume create sdcard/root-current         # This subvolume becomes / at run time. It can be snapshot-ed separately.\n\n# mkdir sdcard/root-current/boot\n\n# mount /dev/sdX1 sdcard/root-current/boot\n\n# bsdtar -xpf ArchLinuxARM-rpi-4-latest.tar.gz -C sdcard/root-current\n```\n\n### configure mounts\n\nEdit `sdcard/root-current/boot/cmdline.txt`, add `rootflags` part to mount the subvolume at `/`:\n\n```diff\n-root=/dev/mmcblk0p2 rw rootwait console=ttyAMA0,115200 ...\n+root=/dev/mmcblk0p2 rootflags=subvol=/root-current rw rootwait console=ttyAMA0,115200 ...\n```\n\nEdit `sdcard/root-current/etc/fstab`, add our mount options (it boots without these lines, but new created files won't get compressed):\n\n```diff\n+/dev/mmcblk0p2  /              btrfs   defaults,compress=lzo,subvol=/root-current       0       0\n+/dev/mmcblk0p2  /media/sdcard  btrfs   defaults,compress=lzo,subvol=/,noauto            0       0\n```\n\nThe `/media/sdcard` mount is not necessary for everyday use. It can be used to manage subvolumes / snapshots.\n\n## Customization and hardening\n\nAfter successfully booting from SD card:\n\n- Modify `/etc/locale.gen` and re-run `locale-gen` (It's strange that the `locale.gen` does not come with any locale.)\n- Recommended: harden sshd and other security config\n\n## Tuneables to minimize SD card IO\n\nAfter the following attempts, I'm already OK with the performance. Stopping here until I need to squeeze more out of it.\n\n### Mount options\n\n- vfat partition: `noatime,nodiratime`\n- btrfs partition: `noatime,nodiratime,compress=lzo,ssd,discard`\n\n### Stop journald from persisting logs\n\n```diff\n# /etc/systemd/journald.conf\n [Journal]\n-Storage=auto\n+Storage=volatile\n```\n\n## Mount remote disk via iSCSI\n\nThis is my first journey about iSCSI but it's smoother than I thought.\n\n### Server aka \"iSCSI target\"\n\n[My NAS](/post/2017-09/freebsd-on-microserver/) runs FreeBSD so I just followed the [29.12.1. Configuring an iSCSI Target](https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/network-iscsi.html).\n\n### Client aka \"iSCSI Initiator\"\n\nsee [archwiki](https://wiki.archlinux.org/index.php/Open-iSCSI)\n\n## Gaming stuff: libretro and joystick\n\nTODO\n\n## Watchlist\n\n### ARMv8 build\n\nThe CPU is ARMv8-capable but I don't see any ARMv8 builds published. Guess I have to check the following links later:\n\n- [Stable 64 bit (arm v8) Raspbian buster on pi 4?](https://www.raspberrypi.org/forums/viewtopic.php?t=245658) @ raspberrypi.org\n- [what about PI 4](https://archlinuxarm.org/forum/viewtopic.php?f=8\u0026t=13734\u0026start=50) @ archlinuxarm.org\n- [Upstream initial Raspberry Pi 4 B support](https://github.com/lategoodbye/rpi-zero/issues/43) @ github\n"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2019-09-14","setup-archlinux-raspberry-pi-4b"]},"buildId":"fTNX2Bow0hdE_-yA1j7ND","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["script",{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"}],["script",{"dangerouslySetInnerHTML":{"__html":"\n            window.dataLayer = window.dataLayer || [];\n            function gtag(){dataLayer.push(arguments);}\n            gtag('js', new Date());\n            gtag('config', 'UA-39627402-1', {\n              page_path: window.location.pathname,\n            });\n          "}}],["title",{"children":"Setup Archlinux on Raspberry Pi 4b"}],["meta",{"httpEquiv":"X-UA-Compatible","content":"IE=edge"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"}],["link",{"rel":"canonical","href":"https://jokester.github.io/posts/2019-09-14/setup-archlinux-raspberry-pi-4b"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-555defa4e62ba07d4446.js"></script><script src="/_next/static/chunks/main-d42d109db6976c01a5e9.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" async=""></script><script src="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" async=""></script><script src="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" async=""></script><script src="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" async=""></script><script src="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" async=""></script><script src="/_next/static/fTNX2Bow0hdE_-yA1j7ND/_buildManifest.js" async=""></script><script src="/_next/static/fTNX2Bow0hdE_-yA1j7ND/_ssgManifest.js" async=""></script></body></html>