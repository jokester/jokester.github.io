<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-39627402-1', {
              page_path: window.location.pathname,
            });
          </script><title>SHA1 Collision and Android APK Signing</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"/><link rel="canonical" href="https://jokester.github.io/posts/2017-02-28/sha1-collision-and-apk-signing"/><link rel="preload" href="/_next/static/css/cbf8b5770f5f30aa7698.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cbf8b5770f5f30aa7698.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-d42d109db6976c01a5e9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" as="script"/><link rel="preload" href="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" as="script"/></head><body class="overflow-y-scroll"><div id="__next"><div class="bg-black text-yellow-100"><div class="min-h-screen container mx-auto"><div class="px-4 py-1 flex items-center bg-gray-900 space-x-4 text-sm"><a class="sm:hidden text-lg" href="/">挖坑自動機</a><a class="hidden sm:inline-block text-lg" href="/">挖坑自動機 / Digging automaton</a><span>|</span><a class="text-yellow-200" href="/posts/">/posts</a><a class="" href="/works/">/works</a><a class="" href="/about/">/about</a></div><div class="px-4 pt-6"><div class="markdown"><h1></h1><hr/><div class="markdown"><p>As a paranoiac Android developer, I was concerned by recent SHA1-collision news.</p><p>After investigating it a bit, I am writing this as a FAQ to answer myself.</p><p>If you need more information, or want to share any ideas, feel free to drop me a comment.</p><ul><li>toc
{:toc}</li></ul><h1>Why should I be concerned?</h1><p>SHA1 was used by default in APK signing for a few years.
You might be using it as either creator or consumer of APK files.</p><h1>What is the worst case?</h1><p>A bad guy <em>may</em> be able to create a APK with his/her malicious code, and identical SHA1 digest of your genuine files. Devices that had previous version will consider the crafted APK to be signed by <em>your</em> certificate, and issue no warning when installing it.</p><h1>Am I still (practically) safe?</h1><p>IMHO the answer is still yes in early 2017.</p><p>In the light side of the world, there are factors that may make actual attack difficult and unprofitable.</p><ul><li>A collision is still expensive to find.</li><li>It may be more difficult to find collision for executable files like <code>.dex</code>.</li><li>APK may not be validated with SHA1 (see the following part).</li><li>A sane user may not install APK from untrusted origin (given that your Play Console account is not compromised).</li></ul><p>And this is the dark side:</p><ul><li>Theoretically there is danger.</li><li>Things can change.</li><li>Android versions before 7.0 (N / SDK 24) , that have no great Signature schama v2, are inherently insecure due to downgrade attack.</li></ul><h1>How is SHA1 used in APK signing?</h1><p>SHA1 and its fellows is used in the <code>digest</code> part of <code>digest-and-sign</code> pattern of <em>digital signature</em>.</p><p>The digest function (MD5 / SHA1 / SHA256) and type of sign key (DSA / RSA / EC) constitutes a <em>Signature Algorithm</em> like <code>SHA1withRSA</code> or <code>SHA256withEC</code>.</p><h2>APK Signature scheme v1</h2><p>Scheme v1 had a few other algorithms, but I&#x27;m afraid a vast majority used <code>SHA1withRSA</code>, it have been default of several tools.</p><h2>APK Signature scheme v2</h2><p>Scheme v2 always use SHA2 and up, and is thus safe against SHA1 collision.</p><p><em>But</em> it is only supported since Android 7.0 (SDK level 24).</p><h1>How is digest function determined for scheme V1?</h1><h2><code>APKsign</code></h2><p>This is the up-to-date sign tool since Android build-tools v24.
<code>APKsign</code> determines digest algorithm from key type and minimum SDK version of APK,
so as to use SHA256 when possible.</p><ul><li><code>SHA256withRSA</code> for minimum SDK 18 (Android 4.3) and up</li><li><code>SHA256withDSA</code> for minimum SDK 21 (Android 5.0) and up</li><li><code>SHA256withEC</code> for minimum SDK 18 and up</li><li><code>SHA1with*</code> for lower minimum SDK levels</li></ul><p>The exact code can be found in <code>V1SchemeSigner.java</code> <a href="https://android.googlesource.com/platform/tools/apksig/">here</a>.</p><h2><code>jarsigner</code></h2><p>This is the outdated tool used before Android build-tools v24. It is distributed as a part of <code>JDK</code>. Android build tools uses it with <code>SHA1with*</code> by default.</p><h1>Can I use both SHA1 and SHA256 in one APK?</h1><p>No.</p><p>An APK that contain more than 1 signature will be rejected by Google Play.</p><p>(similar thing can be done with <code>jar</code>, but google decided to reject such APKs)</p><h1>Can I switch to SHA2?</h1><p>Yes.</p><p>This can be done by setting minimum SDK to a higher value.
However older devices will not be able to install your new APKs.</p><p>Please go on and read <em>why a simply switching is not enough</em>.</p><h1>Is switching to SHA2 (completely) enough?</h1><p>No.</p><p><em>/me sobs</em></p><p>In a few devices I tested, Android installs new APK without warning, as long as it is signed with identical certificate of existing version.</p><p>This means older devices (that only checks scheme v1) is inherently vulenarble to a <em>downgrade attack</em>.
One can overwrite a <code>SHA256withRSA</code>-signed version with a <code>SHA1withRSA</code> APK (maybe made from an old version).</p><h1>What can I do to maximize security?</h1><p>Sign with SHA2, preferably with a new certificate that have not been used with SHA1.</p><p>(We can publish separated APKs for Android 18 and up, see <a href="https://developer.android.com/google/play/publishing/multiple-apks.html">multiple-APKs</a>)</p></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdMeta":{"realpath":"/home/runner/work/jokester.github.io/jokester.github.io/posts/2017/2017-02-28-sha1-collision-and-apk-signing.md","slug":["2017-02-28","sha1-collision-and-apk-signing"],"frontMatter":{"title":"SHA1 Collision and Android APK Signing","publishAt":"2017-02-28"}},"mdContent":"\nAs a paranoiac Android developer, I was concerned by recent SHA1-collision news.\n\nAfter investigating it a bit, I am writing this as a FAQ to answer myself.\n\nIf you need more information, or want to share any ideas, feel free to drop me a comment.\n\n- toc\n  {:toc}\n\n# Why should I be concerned?\n\nSHA1 was used by default in APK signing for a few years.\nYou might be using it as either creator or consumer of APK files.\n\n# What is the worst case?\n\nA bad guy _may_ be able to create a APK with his/her malicious code, and identical SHA1 digest of your genuine files. Devices that had previous version will consider the crafted APK to be signed by _your_ certificate, and issue no warning when installing it.\n\n# Am I still (practically) safe?\n\nIMHO the answer is still yes in early 2017.\n\nIn the light side of the world, there are factors that may make actual attack difficult and unprofitable.\n\n- A collision is still expensive to find.\n- It may be more difficult to find collision for executable files like `.dex`.\n- APK may not be validated with SHA1 (see the following part).\n- A sane user may not install APK from untrusted origin (given that your Play Console account is not compromised).\n\nAnd this is the dark side:\n\n- Theoretically there is danger.\n- Things can change.\n- Android versions before 7.0 (N / SDK 24) , that have no great Signature schama v2, are inherently insecure due to downgrade attack.\n\n# How is SHA1 used in APK signing?\n\nSHA1 and its fellows is used in the `digest` part of `digest-and-sign` pattern of _digital signature_.\n\nThe digest function (MD5 / SHA1 / SHA256) and type of sign key (DSA / RSA / EC) constitutes a _Signature Algorithm_ like `SHA1withRSA` or `SHA256withEC`.\n\n## APK Signature scheme v1\n\nScheme v1 had a few other algorithms, but I'm afraid a vast majority used `SHA1withRSA`, it have been default of several tools.\n\n## APK Signature scheme v2\n\nScheme v2 always use SHA2 and up, and is thus safe against SHA1 collision.\n\n_But_ it is only supported since Android 7.0 (SDK level 24).\n\n# How is digest function determined for scheme V1?\n\n## `APKsign`\n\nThis is the up-to-date sign tool since Android build-tools v24.\n`APKsign` determines digest algorithm from key type and minimum SDK version of APK,\nso as to use SHA256 when possible.\n\n- `SHA256withRSA` for minimum SDK 18 (Android 4.3) and up\n- `SHA256withDSA` for minimum SDK 21 (Android 5.0) and up\n- `SHA256withEC` for minimum SDK 18 and up\n- `SHA1with*` for lower minimum SDK levels\n\nThe exact code can be found in `V1SchemeSigner.java` [here](https://android.googlesource.com/platform/tools/apksig/).\n\n## `jarsigner`\n\nThis is the outdated tool used before Android build-tools v24. It is distributed as a part of `JDK`. Android build tools uses it with `SHA1with*` by default.\n\n# Can I use both SHA1 and SHA256 in one APK?\n\nNo.\n\nAn APK that contain more than 1 signature will be rejected by Google Play.\n\n(similar thing can be done with `jar`, but google decided to reject such APKs)\n\n# Can I switch to SHA2?\n\nYes.\n\nThis can be done by setting minimum SDK to a higher value.\nHowever older devices will not be able to install your new APKs.\n\nPlease go on and read _why a simply switching is not enough_.\n\n# Is switching to SHA2 (completely) enough?\n\nNo.\n\n_/me sobs_\n\nIn a few devices I tested, Android installs new APK without warning, as long as it is signed with identical certificate of existing version.\n\nThis means older devices (that only checks scheme v1) is inherently vulenarble to a _downgrade attack_.\nOne can overwrite a `SHA256withRSA`-signed version with a `SHA1withRSA` APK (maybe made from an old version).\n\n# What can I do to maximize security?\n\nSign with SHA2, preferably with a new certificate that have not been used with SHA1.\n\n(We can publish separated APKs for Android 18 and up, see [multiple-APKs](https://developer.android.com/google/play/publishing/multiple-apks.html))\n"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2017-02-28","sha1-collision-and-apk-signing"]},"buildId":"fTNX2Bow0hdE_-yA1j7ND","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["script",{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"}],["script",{"dangerouslySetInnerHTML":{"__html":"\n            window.dataLayer = window.dataLayer || [];\n            function gtag(){dataLayer.push(arguments);}\n            gtag('js', new Date());\n            gtag('config', 'UA-39627402-1', {\n              page_path: window.location.pathname,\n            });\n          "}}],["title",{"children":"SHA1 Collision and Android APK Signing"}],["meta",{"httpEquiv":"X-UA-Compatible","content":"IE=edge"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"}],["link",{"rel":"canonical","href":"https://jokester.github.io/posts/2017-02-28/sha1-collision-and-apk-signing"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-555defa4e62ba07d4446.js"></script><script src="/_next/static/chunks/main-d42d109db6976c01a5e9.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" async=""></script><script src="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" async=""></script><script src="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" async=""></script><script src="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" async=""></script><script src="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" async=""></script><script src="/_next/static/fTNX2Bow0hdE_-yA1j7ND/_buildManifest.js" async=""></script><script src="/_next/static/fTNX2Bow0hdE_-yA1j7ND/_ssgManifest.js" async=""></script></body></html>