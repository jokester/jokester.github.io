<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"></script><script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-39627402-1', {
              page_path: window.location.pathname,
            });
          </script><title>我的笔记本电脑复活了</title><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"/><link rel="canonical" href="https://jokester.github.io/posts/2017-10-13/restore-btrfs-linux-root"/><link rel="preload" href="/_next/static/css/cbf8b5770f5f30aa7698.css" as="style"/><link rel="stylesheet" href="/_next/static/css/cbf8b5770f5f30aa7698.css" data-n-g=""/><noscript data-n-css="true"></noscript><link rel="preload" href="/_next/static/chunks/main-d42d109db6976c01a5e9.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" as="script"/><link rel="preload" href="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" as="script"/><link rel="preload" href="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" as="script"/></head><body class="overflow-y-scroll"><div id="__next"><div class="bg-black text-yellow-100"><div class="min-h-screen container mx-auto"><div class="px-4 py-1 flex items-center bg-gray-900 space-x-4 text-sm"><a class="sm:hidden text-lg" href="/">挖坑自動機</a><a class="hidden sm:inline-block text-lg" href="/">挖坑自動機 / Digging automaton</a><span>|</span><a class="text-yellow-200" href="/posts/">/posts</a><a class="" href="/works/">/works</a><a class="" href="/about/">/about</a></div><div class="px-4 pt-6"><div class="markdown"><h1></h1><hr/><div class="markdown"><p>上上周我的笔记本 (Lenovo yogabook 710) 因无线网卡故障而送修了，今天拿到了修好的机器。本文记录一下送修前后备份和恢复系统的主要经过。</p><p>这台机是上半年某次特价时买的，性能不强 (i5-7Y54 1.2G 2 核 4 线程)，且键盘手感很一般，
但装了 Arch Linux 后用起来还行 (电池可用 10 小时，没有需要特别折腾的硬件)。
是我不想起床时，以及去公园写东西时的主要用机。</p><h2>Linux 配置</h2><p>文件系统:</p><ul><li>sda1: vfat boot 分区 512M</li><li>sda2: btrfs 主分区 约 240G</li></ul><p>启动管理器: <a href="http://www.rodsbooks.com/refind/">rEFInd</a></p><p>桌面: 一般 xfce / 有时 awesome</p><h2>送修时</h2><ul><li>把硬盘上的当天的 snapshot 发到家里 NAS<ul><li><code># btrfs subvolume send 路径 | gz &gt; /media/iris/disk1/backup/djpon-btrfs.img.gz</code><ul><li><code>/media/iris</code> 是 nas 的 mount 路径</li></ul></li><li>sda1 (<code>/boot</code>) 几乎全是默认设置就没专门备份，直接重建)</li></ul></li><li>抹掉硬盘: usb 启动后 <code>shred /dev/sda</code></li><li>用 usb 装个 win 10 (装好就自动激活了)</li><li>寄回 lenovo</li></ul><h2>修好后</h2><ul><li>用 archlinux 的 liveusb 启动</li><li>重新分区</li><li>恢复文件<ul><li>把主分区的根 volume mount 到 <code>/mnt</code>，记得 <code>-o compress=lzo</code></li><li>把 snapshot 复制回来:<ul><li><code># curl http://iris.local/disk1/backup/djpon-btrfs.img.gz | zcat | btrfs subvolume receive /mnt</code></li><li><code>http://iris</code> 是 nas 的 http 文件共享。用的自己写的 <a href="https://github.com/jokester/toosimple">toosimple</a></li></ul></li><li>上面 receive 出来的 subvolume 还是只读。要再生成一个可读写的 subvolume 用于 <code>/</code><ul><li><code># btrfs subvolume snapshot sysvol-20171001 sysvol</code></li></ul></li><li><code>umount /mnt</code> 并将新建的 sysvol mount 到<code>/mnt</code><ul><li><code># mount -o compress=lzo,subvol=/sysvol</code></li></ul></li></ul></li><li>重新生成 fstab: <code>genfstab -U -p /mnt &gt;&gt; /mnt/etc/fstab.new</code> 然后 vimdiff 回去</li><li>重建 boot<ul><li>把 boot 分区 mount 到 <code>/mnt/boot</code>, arch-chroot 进 <code>/mnt</code>，</li><li>恢复内核和 ucode: <code>pacman -S linux intel-ucode</code><ul><li>如果你的/boot 有更多东西: 可以 <code>pacman -Qkk | grep boot</code> 检查一下哪些包需要恢复</li></ul></li><li>设置启动管理器 (refind)</li></ul></li><li>重启后如果一切正常就可以继续用了</li></ul></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"mdMeta":{"realpath":"/home/runner/work/jokester.github.io/jokester.github.io/posts/2017/2017-10-13-restore-btrfs-linux-root.md","slug":["2017-10-13","restore-btrfs-linux-root"],"frontMatter":{"title":"我的笔记本电脑复活了","publishAt":"2017-10-13"}},"mdContent":"\n上上周我的笔记本 (Lenovo yogabook 710) 因无线网卡故障而送修了，今天拿到了修好的机器。本文记录一下送修前后备份和恢复系统的主要经过。\n\n这台机是上半年某次特价时买的，性能不强 (i5-7Y54 1.2G 2 核 4 线程)，且键盘手感很一般，\n但装了 Arch Linux 后用起来还行 (电池可用 10 小时，没有需要特别折腾的硬件)。\n是我不想起床时，以及去公园写东西时的主要用机。\n\n## Linux 配置\n\n文件系统:\n\n- sda1: vfat boot 分区 512M\n- sda2: btrfs 主分区 约 240G\n\n启动管理器: [rEFInd](http://www.rodsbooks.com/refind/)\n\n桌面: 一般 xfce / 有时 awesome\n\n## 送修时\n\n- 把硬盘上的当天的 snapshot 发到家里 NAS\n  - `# btrfs subvolume send 路径 | gz \u003e /media/iris/disk1/backup/djpon-btrfs.img.gz`\n    - `/media/iris` 是 nas 的 mount 路径\n  - sda1 (`/boot`) 几乎全是默认设置就没专门备份，直接重建)\n- 抹掉硬盘: usb 启动后 `shred /dev/sda`\n- 用 usb 装个 win 10 (装好就自动激活了)\n- 寄回 lenovo\n\n## 修好后\n\n- 用 archlinux 的 liveusb 启动\n- 重新分区\n- 恢复文件\n  - 把主分区的根 volume mount 到 `/mnt`，记得 `-o compress=lzo`\n  - 把 snapshot 复制回来:\n    - `# curl http://iris.local/disk1/backup/djpon-btrfs.img.gz | zcat | btrfs subvolume receive /mnt`\n    - `http://iris` 是 nas 的 http 文件共享。用的自己写的 [toosimple](https://github.com/jokester/toosimple)\n  - 上面 receive 出来的 subvolume 还是只读。要再生成一个可读写的 subvolume 用于 `/`\n    - `# btrfs subvolume snapshot sysvol-20171001 sysvol`\n  - `umount /mnt` 并将新建的 sysvol mount 到`/mnt`\n    - `# mount -o compress=lzo,subvol=/sysvol`\n- 重新生成 fstab: `genfstab -U -p /mnt \u003e\u003e /mnt/etc/fstab.new` 然后 vimdiff 回去\n- 重建 boot\n  - 把 boot 分区 mount 到 `/mnt/boot`, arch-chroot 进 `/mnt`，\n  - 恢复内核和 ucode: `pacman -S linux intel-ucode`\n    - 如果你的/boot 有更多东西: 可以 `pacman -Qkk | grep boot` 检查一下哪些包需要恢复\n  - 设置启动管理器 (refind)\n- 重启后如果一切正常就可以继续用了\n"},"__N_SSG":true},"page":"/posts/[...slug]","query":{"slug":["2017-10-13","restore-btrfs-linux-root"]},"buildId":"tlxtjnvNyuDsinQss6fzz","nextExport":false,"isFallback":false,"gsp":true,"head":[["meta",{"charSet":"utf-8"}],["script",{"async":true,"src":"https://www.googletagmanager.com/gtag/js?id=UA-39627402-1"}],["script",{"dangerouslySetInnerHTML":{"__html":"\n            window.dataLayer = window.dataLayer || [];\n            function gtag(){dataLayer.push(arguments);}\n            gtag('js', new Date());\n            gtag('config', 'UA-39627402-1', {\n              page_path: window.location.pathname,\n            });\n          "}}],["title",{"children":"我的笔记本电脑复活了"}],["meta",{"httpEquiv":"X-UA-Compatible","content":"IE=edge"}],["meta",{"name":"viewport","content":"width=device-width, initial-scale=1,maximum-scale=1.5,minimum-scale=1"}],["link",{"rel":"canonical","href":"https://jokester.github.io/posts/2017-10-13/restore-btrfs-linux-root"}]]}</script><script nomodule="" src="/_next/static/chunks/polyfills-555defa4e62ba07d4446.js"></script><script src="/_next/static/chunks/main-d42d109db6976c01a5e9.js" async=""></script><script src="/_next/static/chunks/webpack-e067438c4cf4ef2ef178.js" async=""></script><script src="/_next/static/chunks/commons.2a955b2cc4cd676398e3.js" async=""></script><script src="/_next/static/chunks/pages/_app-7c12fd0ca2279e9deba3.js" async=""></script><script src="/_next/static/chunks/framework.e6a38dee2f8f3a7cf1e7.js" async=""></script><script src="/_next/static/chunks/b7536e739236ba09df46895b208080d021a349b5.79dc8a8b4f0d930fbecb.js" async=""></script><script src="/_next/static/chunks/b52a6c8fe9dfc388856b15614b0f9ba4172af7a6.1c0a2366dab843a4556e.js" async=""></script><script src="/_next/static/chunks/pages/posts/%5B...slug%5D-1862802d0a4a1972e3d1.js" async=""></script><script src="/_next/static/tlxtjnvNyuDsinQss6fzz/_buildManifest.js" async=""></script><script src="/_next/static/tlxtjnvNyuDsinQss6fzz/_ssgManifest.js" async=""></script></body></html>